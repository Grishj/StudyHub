// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String    @id @default(uuid())
  email                  String    @unique
  password               String
  fullName               String
  avatar                 String?
  bio                    String?
  isEmailVerified        Boolean   @default(false)
  emailVerificationToken String?
  passwordResetToken     String?
  passwordResetExpires   DateTime?
  refreshToken           String?
  lastLogin              DateTime?
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  // Relations
  profile         Profile?
  notes           Note[]
  questions       Question[]
  quizAttempts    QuizAttempt[]
  groups          GroupMember[]
  bookmarks       Bookmark[]
  notifications   Notification[]
  achievements    UserAchievement[]
  progress        UserProgress[]
  aiConversations AIConversation[]
  votes           Vote[]
  comments        Comment[]
  reports         Report[]
  groupMessages   GroupMessage[]
  uploadedFiles   UploadedFile[]
  downloadHistory DownloadHistory[]

  @@map("users")
}

model Profile {
  id             String    @id @default(uuid())
  userId         String    @unique
  phone          String?
  dateOfBirth    DateTime?
  address        String?
  targetExam     String? // NRB, NTC, NEA, Federal
  points         Int       @default(0)
  streak         Int       @default(0)
  lastActiveDate DateTime  @default(now())
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("profiles")
}

model Category {
  id          String   @id @default(uuid())
  name        String   @unique // NRB, NTC, NEA, Federal
  description String?
  icon        String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  syllabi   Syllabus[]
  notes     Note[]
  questions Question[]
  quizzes   Quiz[]

  @@map("categories")
}

// Update Syllabus model
model Syllabus {
  id          String   @id @default(uuid())
  categoryId  String
  title       String
  description String?
  content     String   @db.Text
  fileUrl     String?
  order       Int      @default(0)
  viewCount   Int      @default(0)     // NEW
  downloadCount Int    @default(0)     // NEW
  isPublished Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  category    Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@map("syllabi")
}

// Update Note model
model Note {
  id          String   @id @default(uuid())
  userId      String
  categoryId  String
  title       String
  content     String   @db.Text
  fileType    String?
  fileUrl     String?
  tags        String[]
  viewCount   Int      @default(0)
  upvotes     Int      @default(0)
  downvotes   Int      @default(0)
  downloadCount Int    @default(0)  // NEW
  isApproved  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  category    Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  votes       Vote[]
  comments    Comment[]
  bookmarks   Bookmark[]

  @@map("notes")
}

// Update Question model
model Question {
  id          String   @id @default(uuid())
  userId      String
  categoryId  String
  title       String
  content     String   @db.Text
  year        Int?
  fileUrl     String?
  tags        String[]
  viewCount   Int      @default(0)
  upvotes     Int      @default(0)
  downvotes   Int      @default(0)
  downloadCount Int    @default(0)  // NEW
  isApproved  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  category    Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  votes       Vote[]
  comments    Comment[]
  bookmarks   Bookmark[]

  @@map("questions")
}

model Quiz {
  id          String   @id @default(uuid())
  categoryId  String?
  title       String
  description String?
  difficulty  String   @default("medium") // easy, medium, hard
  timeLimit   Int? // in minutes
  isDaily     Boolean  @default(false)
  isPublished Boolean  @default(true)
  date        DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  category  Category?      @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  questions QuizQuestion[]
  attempts  QuizAttempt[]

  @@map("quizzes")
}

model QuizQuestion {
  id            String   @id @default(uuid())
  quizId        String
  question      String   @db.Text
  options       Json // Array of options
  correctAnswer String
  explanation   String?  @db.Text
  points        Int      @default(1)
  order         Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@map("quiz_questions")
}

model QuizAttempt {
  id             String   @id @default(uuid())
  userId         String
  quizId         String
  score          Int
  totalQuestions Int
  correctAnswers Int
  timeTaken      Int? // in seconds
  answers        Json // User's answers
  completedAt    DateTime @default(now())
  createdAt      DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@map("quiz_attempts")
}

model Vote {
  id         String   @id @default(uuid())
  userId     String
  noteId     String?
  questionId String?
  voteType   String // upvote, downvote
  createdAt  DateTime @default(now())

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  note     Note?     @relation(fields: [noteId], references: [id], onDelete: Cascade)
  question Question? @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([userId, noteId])
  @@unique([userId, questionId])
  @@map("votes")
}

model Comment {
  id         String   @id @default(uuid())
  userId     String
  noteId     String?
  questionId String?
  content    String   @db.Text
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  note     Note?     @relation(fields: [noteId], references: [id], onDelete: Cascade)
  question Question? @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("comments")
}

model Bookmark {
  id         String   @id @default(uuid())
  userId     String
  noteId     String?
  questionId String?
  createdAt  DateTime @default(now())

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  note     Note?     @relation(fields: [noteId], references: [id], onDelete: Cascade)
  question Question? @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([userId, noteId])
  @@unique([userId, questionId])
  @@map("bookmarks")
}

model Group {
  id          String   @id @default(uuid())
  name        String
  description String?
  avatar      String?
  type        String   @default("public") // public, private
  category    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members  GroupMember[]
  messages GroupMessage[]

  @@map("groups")
}

model GroupMember {
  id       String   @id @default(uuid())
  groupId  String
  userId   String
  role     String   @default("member") // admin, moderator, member
  joinedAt DateTime @default(now())

  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@map("group_members")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  title     String
  message   String
  type      String // info, success, warning, error
  isRead    Boolean  @default(false)
  data      Json?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model Achievement {
  id          String   @id @default(uuid())
  name        String   @unique
  description String
  icon        String?
  points      Int      @default(0)
  criteria    Json // Conditions to unlock
  createdAt   DateTime @default(now())

  users UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            String   @id @default(uuid())
  userId        String
  achievementId String
  unlockedAt    DateTime @default(now())

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@map("user_achievements")
}

model UserProgress {
  id          String   @id @default(uuid())
  userId      String
  topic       String
  progress    Int      @default(0) // 0-100
  lastStudied DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, topic])
  @@map("user_progress")
}

model AIConversation {
  id        String   @id @default(uuid())
  userId    String
  title     String   @default("New Conversation")
  messages  Json // Array of messages
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("ai_conversations")
}

model Report {
  id          String   @id @default(uuid())
  userId      String
  contentType String // note, question, comment
  contentId   String
  reason      String
  description String?  @db.Text
  status      String   @default("pending") // pending, reviewed, resolved
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("reports")
}

model GroupMessage {
  id          String   @id @default(uuid())
  groupId     String
  userId      String
  content     String   @db.Text
  messageType String   @default("text") // text, image, file, audio, video
  fileUrl     String?
  fileName    String?
  fileSize    Int?
  replyToId   String?
  isEdited    Boolean  @default(false)
  isDeleted   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  group   Group          @relation(fields: [groupId], references: [id], onDelete: Cascade)
  sender  User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  replyTo GroupMessage?  @relation("MessageReplies", fields: [replyToId], references: [id], onDelete: SetNull)
  replies GroupMessage[] @relation("MessageReplies")

  @@index([groupId, createdAt])
  @@map("group_messages")
}

model UploadedFile {
  id           String   @id @default(uuid())
  userId       String
  fileName     String
  originalName String
  mimeType     String
  size         Int
  path         String
  url          String
  category     String? // note, question, syllabus, profile, group, chat
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("uploaded_files")
}
model DownloadHistory {
  id          String   @id @default(uuid())
  userId      String?
  contentType String   // note, question, syllabus
  contentId   String
  downloadedAt DateTime @default(now())

  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([contentType, contentId])
  @@map("download_history")
}